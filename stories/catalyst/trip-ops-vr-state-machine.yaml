id: trip-ops-vr-state-machine
title: "VehicleRun — 16-State Machine Lifecycle"
description: >
  The complete VehicleRun lifecycle from SGR creation through the driver offer
  negotiation, active stop-to-stop routing, post-trip Conductor validation, and
  settlement archival. Four distinct phases enforced by VrStateMachine.cs.
renderer: state-diagram
direction: TB

phases:
  - id: pre-dispatch
    label: "Pre-Dispatch · Offer"
    color: "rgba(59, 130, 246, 0.06)"
    order: 1
  - id: active-route
    label: "Active Route"
    color: "rgba(5, 150, 105, 0.07)"
    order: 2
  - id: post-trip
    label: "Post-Trip Validation"
    color: "rgba(245, 158, 11, 0.07)"
    order: 3
  - id: settlement
    label: "Settlement & Archive"
    color: "rgba(139, 92, 246, 0.07)"
    order: 4

states:
  # ── Phase 1: Pre-Dispatch ──
  - id: new
    label: NEW
    type: initial
    phase: pre-dispatch
    description: "Created by SGR generation or ad-hoc dispatch. Zero dependencies — pure domain state."

  - id: reserved
    label: RESERVED
    type: normal
    variant: info
    phase: pre-dispatch
    description: "Driver + vehicle matched by Assignment BC. Fires VrStateChangedEvent."

  - id: offer-queued
    label: OFFERQUEUED
    type: normal
    variant: info
    phase: pre-dispatch
    description: "Offer queued in system. 30-minute expiry prevents indefinite locks."

  - id: offer-sent
    label: OFFERSENT
    type: normal
    variant: info
    phase: pre-dispatch
    description: "Firebase push notification sent to driver's mobile device (MDD)."

  - id: offer-confirmed
    label: OFFERCONFIRMED
    type: normal
    variant: info
    phase: pre-dispatch
    description: "Driver confirmed receipt. Awaiting explicit acceptance."

  - id: offer-accepted
    label: OFFERACCEPTED
    type: normal
    variant: success
    phase: pre-dispatch
    description: "Driver accepted — FleetEngineVehicleId registered. Fires VrDispatchedEvent ⚡"

  # ── Phase 2: Active Route ──
  - id: tostop
    label: TOSTOP
    type: normal
    variant: default
    phase: active-route
    description: "Driving to next stop. GPS telemetry flows every 30s. SignalR broadcasts live."

  - id: atstop
    label: ATSTOP
    type: normal
    variant: default
    phase: active-route
    description: "Arrived at stop. Fires StopArrivedEvent. Loading or unloading passengers."

  - id: break
    label: BREAK
    type: normal
    variant: warning
    phase: active-route
    description: "Driver on a scheduled break. Returns to TOSTOP via EndBreak()."

  # ── Phase 3: Post-Trip Validation ──
  - id: postservice
    label: POSTSERVICE
    type: normal
    variant: warning
    phase: post-trip
    description: "Last stop departed. Conductor ValidateCompletenessTask begins."

  - id: postcompleteness
    label: POSTCOMPLETENESS
    type: normal
    variant: warning
    phase: post-trip
    description: "All stops accounted for. GPS trails verified. Conductor ValidateBillingReadinessTask next."

  - id: postreadiness
    label: POSTREADINESS
    type: normal
    variant: warning
    phase: post-trip
    description: "Billing data validated. Ready for CompleteVr → settlement gate."

  # ── Phase 4: Settlement ──
  - id: booked
    label: BOOKED
    type: normal
    variant: success
    phase: settlement
    description: "Settlement-ready. Fires VehicleRunCompletedEvent ⚡ → Settlement BC calculates BC/PD/PM."

  - id: settled
    label: SETTLED
    type: normal
    variant: success
    phase: settlement
    description: "BC/PD/PM calculations complete. Driver payment locked."

  - id: archived
    label: ARCHIVED
    type: terminal
    phase: settlement
    description: "Terminal state. Allowed-transitions list is empty. Journey complete."

  # ── Terminal: Cancellation ──
  - id: cancelled
    label: CANCELLED
    type: terminal
    description: "Irreversible cancellation from any pre-settlement state. Fires VrCancelledEvent → Assignment BC re-matches PTs."

transitions:
  # Pre-Dispatch offer chain
  - { id: t1,  source: new,             target: reserved,         trigger: "ReserveVr",    note: "Assignment BC matched" }
  - { id: t2,  source: reserved,        target: offer-queued,     trigger: "QueueOffer",   note: "30-min expiry starts" }
  - { id: t3,  source: offer-queued,    target: offer-sent,       trigger: "SendOffer",    note: "FCM push → driver app" }
  - { id: t4,  source: offer-sent,      target: offer-confirmed,  trigger: "ConfirmOffer", note: "Driver confirmed receipt" }
  - { id: t5,  source: offer-confirmed, target: offer-accepted,   trigger: "AcceptOffer",  note: "VrDispatchedEvent ⚡" }

  # Active Route cycling
  - { id: t6,  source: offer-accepted,  target: tostop,           trigger: "StartVr",         note: "VehicleRunStartedEvent ⚡" }
  - { id: t7,  source: tostop,          target: atstop,           trigger: "ArriveAtStop",    note: "StopArrivedEvent → GPS validated" }
  - { id: t8,  source: atstop,          target: tostop,           trigger: "DepartStop",      note: "StopDepartedEvent — not last stop" }
  - { id: t9,  source: tostop,          target: break,            trigger: "StartBreak" }
  - { id: t10, source: break,           target: tostop,           trigger: "EndBreak" }
  - { id: t11, source: atstop,          target: break,            trigger: "StartBreak" }

  # Post-Trip entry from ATSTOP (last stop departure)
  - { id: t12, source: atstop,          target: postservice,      trigger: "DepartLastStop",       note: "ATSTOP → POSTSERVICE — Conductor kicks in" }

  # Post-Trip validation (Conductor-orchestrated)
  - { id: t13, source: postservice,     target: postcompleteness, trigger: "ValidateCompleteness", note: "All stops complete?" }
  - { id: t14, source: postcompleteness,target: postreadiness,    trigger: "ValidateReadiness",    note: "Billing data valid?" }
  - { id: t15, source: postreadiness,   target: booked,           trigger: "CompleteVr",           note: "VehicleRunCompletedEvent ⚡" }

  # Settlement
  - { id: t16, source: booked,          target: settled,          trigger: "Settle",   note: "Settlement BC processed" }
  - { id: t17, source: settled,         target: archived,         trigger: "Archive",  note: "Terminal — empty transitions" }

  # Cancellation paths — from VrStateMachine._allowedTransitions (all pre-settlement states except BREAK)
  - { id: tc1, source: new,             target: cancelled,        trigger: "Cancel" }
  - { id: tc2, source: reserved,        target: cancelled,        trigger: "Cancel" }
  - { id: tc3, source: offer-queued,    target: cancelled,        trigger: "Cancel" }
  - { id: tc4, source: offer-sent,      target: cancelled,        trigger: "Cancel" }
  - { id: tc5, source: offer-confirmed, target: cancelled,        trigger: "Cancel" }
  - { id: tc6, source: offer-accepted,  target: cancelled,        trigger: "Cancel" }
  - { id: tc7, source: tostop,          target: cancelled,        trigger: "Cancel" }
  - { id: tc8, source: atstop,          target: cancelled,        trigger: "Cancel",  note: "VrCancelledEvent ⚡" }

steps:
  - id: step-1
    title: "A Vehicle Run is Born"
    narrative: >
      Every VehicleRun starts in NEW — created either by the nightly SGR generation
      (SubscriptionRun templates → VRs) or manually via CreateAdHocTripCommand.
      The 16-state machine in VrStateMachine.cs is a static Dictionary<VrStatus, List<VrStatus>>
      transition matrix. CanTransition() is called before any state change occurs.
    activeStates: [new]
    activeTransitions: []
    duration: 5000
    narration:
      speaker: Architect
      message: "Every VR begins here. NEW is the genesis state — SGR or ad-hoc. The state machine is immutable by design."

  - id: step-2
    title: "Phase 1 — The Offer Negotiation"
    narrative: >
      The Assignment BC matches a driver, then the 4-step offer workflow unfolds:
      ReserveVr → QueueOffer → SendOffer (Firebase push to driver's MDD) →
      ConfirmOffer → AcceptOffer. Each transition is guarded by VrStateMachine.CanTransition().
      AcceptOffer registers the FleetEngineVehicleId — GPS tracking starts here.
    activeStates: [new, reserved, offer-queued, offer-sent, offer-confirmed, offer-accepted]
    activeTransitions: [t1, t2, t3, t4, t5]
    duration: 6000
    narration:
      speaker: Domain Expert
      message: "Six pre-dispatch states. The offer workflow guarantees no driver is committed without explicit acceptance."

  - id: step-3
    title: "Phase 2 — Active Route: Stop Cycling"
    narrative: >
      StartVr transitions to TOSTOP. The driver cycles TOSTOP ↔ ATSTOP for each
      stop on the route. Each ArriveAtStop validates GPS position. DepartStop
      from a non-final stop returns to TOSTOP. BREAK is available from both TOSTOP
      and ATSTOP. GPS telemetry flows every 30 seconds; SignalR broadcasts live.
    activeStates: [offer-accepted, tostop, atstop, break]
    activeTransitions: [t6, t7, t8, t9, t10, t11]
    duration: 6000
    narration:
      speaker: Domain Expert
      message: "TOSTOP and ATSTOP cycle for every stop. BREAK from either state. This is the operational heartbeat."

  - id: step-4
    title: "Phase 3 — Post-Trip: From ATSTOP to Conductor"
    narrative: >
      The last stop's departure from ATSTOP goes directly to POSTSERVICE — not through
      TOSTOP. This is the transition that starts the Conductor post-trip-processing-workflow:
      ValidateCompletenessTask → ValidateBillingReadinessTask → BookVehicleRunTask.
      The VR is blocked from settlement until all three Conductor tasks complete.
    activeStates: [postservice, postcompleteness, postreadiness]
    activeTransitions: [t12, t13, t14]
    duration: 5500
    narration:
      speaker: Architecture Lead
      message: "ATSTOP → POSTSERVICE directly on last stop departure. Conductor validates everything before the settlement gate opens."

  - id: step-5
    title: "Phase 4 — Settlement & Archival"
    narrative: >
      CompleteVr → BOOKED fires VehicleRunCompletedEvent. The Settlement BC
      processes BC/PD/PM calculations. Once SETTLED, Archive() moves the VR
      to ARCHIVED — a terminal state with an empty allowed-transitions list.
      The route lifecycle is complete.
    activeStates: [booked, settled, archived]
    activeTransitions: [t15, t16, t17]
    duration: 5000
    narration:
      speaker: Architect
      message: "BOOKED → SETTLED → ARCHIVED. Three states, one direction, no reversal. Terminal states have empty transition lists."

  - id: step-6
    title: "The Escape Hatch — Cancellation from 8 States"
    narrative: >
      CANCELLED is reachable from 8 states: NEW, RESERVED, OFFERQUEUED, OFFERSENT,
      OFFERCONFIRMED, OFFERACCEPTED, TOSTOP, and ATSTOP. Notably NOT from BREAK,
      POSTSERVICE, POSTCOMPLETENESS, or POSTREADINESS — the VrStateMachine transition
      matrix is explicit. VrCancelledEvent fires → Assignment BC re-matches all PTs.
    activeStates: [cancelled]
    activeTransitions: [tc1, tc2, tc3, tc4, tc5, tc6, tc7, tc8]
    duration: 5000
    narration:
      speaker: Domain Expert
      message: "8 cancellation entry points — more than expected! Once in post-trip validation, cancellation is no longer possible."

  - id: step-7
    title: "The Complete 16-State VR Lifecycle"
    narrative: >
      16 states. 4 phases. One static Dictionary<VrStatus, List<VrStatus>>.
      Every legal transition validated before any persistence. Invalid transitions
      raise DomainException — not a database error, not a 500. This is ADR-008's
      transition matrix pattern in its canonical form. Key insight: ATSTOP → POSTSERVICE
      on the last stop, not TOSTOP → POSTSERVICE.
    activeStates: [new, reserved, offer-queued, offer-sent, offer-confirmed, offer-accepted, tostop, atstop, break, postservice, postcompleteness, postreadiness, booked, settled, archived, cancelled]
    activeTransitions: [t1, t2, t3, t4, t5, t6, t7, t8, t9, t10, t11, t12, t13, t14, t15, t16, t17, tc1, tc2, tc3, tc4, tc5, tc6, tc7, tc8]
    duration: 6000
    narration:
      speaker: Architecture Lead
      message: "The full 16-state VehicleRun lifecycle. 8 states can cancel. ATSTOP is the post-trip gate. ARCHIVED is the end."
